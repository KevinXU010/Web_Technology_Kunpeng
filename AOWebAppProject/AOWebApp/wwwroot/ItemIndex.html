<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shop Items</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>
<body>
    <div class="container py-3">
        <h1 class="alert alert-secondary text-center mb-4">Shop Items</h1>

        <div class="row g-2 mb-3 align-items-end">
            <div class="col-sm-6 col-lg-5">
                <input id="searchText" class="form-control" placeholder="Search items..." />
            </div>
            <div class="col-sm-4 col-lg-3">
                <select id="categorySelect" class="form-select">
                    <option value="">All Categories...</option>
                </select>
            </div>
            <div class="col-sm-2 col-lg-2 d-grid">
                <button id="btnSearch" type="button" class="btn btn-primary">Search</button>
            </div>
            <div class="col-sm-12 col-lg-2 d-grid">
                <button id="btnReset" type="button" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>



        <div id="itemsRow" class="row justify-content-start mt-2">
          
            <div class="col-12 col-sm-6 col-lg-4 mb-2" hidden>
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Card title</h5>
                        <p class="card-text">Card text</p>
                        <p class="card-text">Price</p>
                    </div>
                    <img src="https://via.placeholder.com/480x300?text=Image"
                         class="card-img-bottom" alt="..." loading="lazy">
                </div>
            </div>
        </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    var row = document.querySelector('#itemsRow');
    var template = row.querySelector('[hidden]');
    var ddl = document.querySelector('#categorySelect');
    var txt = document.querySelector('#searchText');
    var btnSearch = document.querySelector('#btnSearch');
    var btnReset = document.querySelector('#btnReset');

    
    fetch('/api/ParentCategoriesWebAPI')
      .then(function (r) { return r.json(); })
      .then(function (cats) {
        cats.forEach(function (c) {
          var opt = document.createElement('option');
          opt.value = c.categoryId || c.CategoryId;
          opt.text  = c.categoryName || c.CategoryName;
          ddl.appendChild(opt);
        });
      })
      .catch(function (e) { console.error('Load categories failed:', e); });

    function clearCards() {
      while (row.children.length > 1) {
        row.removeChild(row.lastElementChild);
      }
    }

    function buildItems(data) {
      for (let i = 0; i < data.length; i++) {
        var col = template.cloneNode(true);

        var name  = data[i].itemName || data[i].ItemName || '(no name)';
        var desc  = data[i].itemDescription || data[i].ItemDescription || '';
        var cost  = parseFloat((data[i].itemCost != null ? data[i].itemCost : data[i].ItemCost) || 0);
        var image = data[i].itemImage || data[i].ItemImage || 'https://via.placeholder.com/480x300?text=No+Image';

        col.querySelector('h5').innerText = name;
        var pList = col.querySelectorAll('p');
        if (pList[0]) pList[0].innerText = desc;
        if (pList[1]) pList[1].innerText = 'Price: $' + cost.toFixed(2);

        var img = col.querySelector('img');
        img.setAttribute('src', image);
        img.setAttribute('alt', 'Image of ' + name);

        col.hidden = false;
        row.appendChild(col);
      }
    }

    function searchAndRender() {
      var searchText = (txt.value || '').trim();
      var categoryId = ddl.value;

      clearCards();
      var parts = [];
      if (searchText) parts.push('searchText=' + encodeURIComponent(searchText));
      if (categoryId) parts.push('categoryId=' + encodeURIComponent(categoryId));
      var url = '/api/ItemsWebAPI' + (parts.length ? '?' + parts.join('&') : '');

      fetch(url)
        .then(function (r) { return r.json(); })
        .then(function (items) {
          if (!items || items.length === 0) {
            var div = document.createElement('div');
            div.className = 'text-muted';
            div.innerText = '(no items)';
            row.appendChild(div);
            return;
          }
          buildItems(items);
        })
        .catch(function (e) {
          var div = document.createElement('div');
          div.className = 'text-danger';
          div.innerText = 'Failed to load items: ' + e.message;
          row.appendChild(div);
          console.error(e);
        });
    }

    btnSearch.addEventListener('click', searchAndRender);
    txt.addEventListener('keydown', function (ev) { if (ev.key === 'Enter') searchAndRender(); });
    btnReset.addEventListener('click', function () { txt.value = ''; ddl.value = ''; searchAndRender(); });

   
    searchAndRender();
  </script>
</body>
</html>
